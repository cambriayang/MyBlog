---
layout: post
title: 关于 iOS 打点那点事
category: iOS
date: 2017-03-19 23:10:00 +0800
tags: [业务处理]
---
本篇博客简单的介绍一下埋点以及埋点的一些功用，以及一些粗浅的认识

## 什么是打点？
首先简单介绍下什么是打点以及打点有什么作用，打点英文其实就是 Record
作用其实就是对想要关心的业务或者关键路径进行记录上传到特定的服务器便于后期分析。

## 打点分类

为了解决前端埋点的准确性、及时性、开发效率等问题，业内各家公司从不同角度，提出了多种技术方案，这些方案大体上可以归为三类：

* 代码埋点：手动使用 recordEvent 等方式埋点
* 声明式埋点：将代码埋点和业务逻辑解耦和
* 无痕埋点：使用 AOP 进行埋点

代码埋点是一种典型的命令式编程，因此埋点代码常常要侵入具体的业务逻辑，这使埋点代码变得很繁琐并且容易出错。因此，**最直接的做法就是将埋点代码与业务逻辑解耦**。

比如：
    
    if (isLoggedin) {
        [[ACYTracker instance] recordEvent:@{@"category":@"abc", @"action":@"login"}];
    }

这就是一个典型的代码埋点。当然这需要业务员在自己的代码逻辑中添加相应埋点，侵入原有代码，如果再由于这些埋点时间而导致一些crash就得不偿失了。

代码埋点需要解决2个问题：

* 声明控件的的唯一标示（bid）
* 业务字段（运行时机才会得知）

### 事件标示
为了自动生成事件标识，我们需要获取每个控件自身的ID、类名以及位于所属父组件的Index等特征信息，并逐级向上遍历找到根节点。根节点一般是手动标记的，如果没有标记则默认是视图层次树的顶层节点。最后，将遍历产生的路径上所有节点的特征信息组合在一起，就是这个事件的标识。考虑到在实际布局中有可能存在一些动态插入的控件，我们允许父组件的Index有一定的误差（大概率不需要考虑）。

### 数据关联
采用更常见的前端数据联系的方式注入。

### 小结
通过自动产生事件标识并进行数据关联，我们就能够实现“无痕埋点”了，并且埋点节点可以通过配置文件动态下发，从而具备了动态部署与修复埋点的能力。但需要注意的是，这种“无痕埋点”并不能解决所有问题，当业务字段无法通过数据关联获取时（这种情况比较常见），仍然需要开发者代码埋点或声明式埋点指定业务字段。


